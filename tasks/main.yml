---
- name: Install Heimdall
  become: true
  tags: install
  block:

    - name: Create heimdall_config volume
      docker_volume:
        driver: "local"
        driver_options:
          type: nfs
          o: "addr={{ nas }},nolock,soft,rw"
          device: "{{ heimdall_config_nfs }}"
        volume_name: heimdall_config

    - name: Create Heimdall container
      community.docker.docker_container:
        name: heimdall
        image: lscr.io/linuxserver/heimdall:latest
        pull: true
        restart_policy: unless-stopped
        volumes:
          - heimdall_config:/config
        networks:
          - name: proxy_net
        env:
          TZ: Asia/Bangkok
          PUID: "{{ heimdall_uid }}"
          PGID: "{{ heimdall_gid }}"

    - name: Setup cron job to stop heimdall for backup
      ansible.builtin.cron:
        name: "Pause heimdall for backup"
        hour: "4"
        minute: "0"
        job: "sudo docker stop heimdall"

    - name: Setup cron job to start heimdall after backup
      ansible.builtin.cron:
        name: "Resume heimdall after backup"
        hour: "5"
        minute: "0"
        job: "sudo docker start heimdall"
